<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Holiday Clock (Responsive & Nested)</title>
    <style>
        :root {
            --apple-font: -apple-system, BlinkMacSystemFont, "SF Pro SC", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            --dark-text: #1d1d1f;
            --accent-color: #007AFF;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: var(--apple-font); display: flex; justify-content: center; align-items: center; }
        #fluid-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; filter: blur(40px); transform: scale(1.1); }
       
        .main-wrapper {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(50px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 48px;
            padding: 20px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.3);
            position: relative; z-index: 10;
            display: flex; gap: 20px;
            box-sizing: border-box;
        }
       
        .clock-section {
            flex: 1;
            text-align: center;
            min-width: 300px;
        }
       
        .info-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(30px);
            border-radius: 36px;
            padding: 30px;
            flex-basis: 300px;
            color: var(--dark-text);
            text-align: left;
            flex-shrink: 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
       
        @media (max-width: 768px) {
            .main-wrapper {
                flex-direction: column;
                max-width: 400px;
            }
            .info-card {
                flex-basis: auto;
            }
        }
        .info-item { margin-bottom: 15px; }
        .info-label { font-size: 0.8rem; font-weight: 600; color: rgba(0,0,0,0.5); letter-spacing: 2px; margin-bottom: 5px; display: block; }
        .info-value { font-size: 1rem; font-weight: 700; opacity: 0.85; }
        #time { font-size: 4.5rem; font-weight: 900; letter-spacing: -3px; font-variant-numeric: tabular-nums; margin: 10px 0 20px; color: var(--dark-text); text-shadow: 0 0 1px rgba(0, 0, 0, 0.1), 0 4px 15px rgba(0, 0, 0, 0.1); }
        #countdown { font-size: 1.6rem; font-weight: 700; color: var(--dark-text); margin-bottom: 30px; }
        .controls { background: rgba(0, 0, 0, 0.05); border-radius: 30px; padding: 25px; display: grid; gap: 20px; text-align: left; }
        .row { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.7rem; font-weight: 800; color: rgba(0,0,0,0.4); letter-spacing: 1px; }
        input { width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; color: var(--dark-text); outline: none; font-family: var(--apple-font); cursor: pointer; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 10px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .custom-calendar-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); z-index: 1000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .custom-calendar-modal.is-active { display: flex; opacity: 1; }
        .calendar-content { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(25px); border-radius: 30px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 350px; text-align: center; overflow: hidden; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-header h2 { font-size: 1.2rem; font-weight: 700; color: var(--dark-text); }
        .nav-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--accent-color); padding: 5px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; }
        .calendar-weekdays div { font-size: 0.8rem; font-weight: 600; color: rgba(0,0,0,0.5); }
        .calendar-days-wrapper { position: relative; height: 240px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; position: absolute; width: 100%; }
        .day { padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1rem; transition: background 0.2s, color 0.2s; }
        .day:hover { background: rgba(0, 0, 0, 0.1); }
        .day.inactive { color: rgba(0, 0, 0, 0.3); pointer-events: none; }
        .day.today { border: 1px solid var(--accent-color); }
        .day.selected { background: var(--accent-color); color: white; font-weight: 700; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); border-radius: 50%; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-size: 1rem; color: var(--dark-text); cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .picker-btn { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); color: var(--accent-color); border: 1px solid rgba(0, 122, 255, 0.2); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: var(--apple-font); font-weight: 600; margin-top: 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .picker-btn:hover { background: rgba(255, 255, 255, 0.6); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        .days-enter { animation: slideIn 0.3s forwards cubic-bezier(0.4, 0, 0.2, 1); }
        .days-leave { animation: slideOut 0.3s forwards cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
    <canvas id="fluid-canvas"></canvas>
   
    <div class="main-wrapper">
        <div class="clock-section">
            <div id="location-time" style="font-size: 0.8rem; font-weight: 600; color: rgba(0,0,0,0.5); letter-spacing: 4px;">åŠ è½½ä¸­...</div>
            <div id="time">00:00:00.000</div>
            <div id="label" style="font-size: 0.9rem; color: rgba(0,0,0,0.6); margin-bottom: 5px;"></div>
            <div id="countdown">è½½å…¥ä¸­...</div>
            <div class="controls">
                <div class="row"> <label>ANIMATION SPEED (æµé€Ÿ)</label> <input type="range" id="speed" min="0.005" max="0.08" step="0.001" value="0.02"> </div>
                <div class="row"> <label>FESTIVAL NAME</label> <input type="text" id="festName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥"> </div>
                <div class="row"> <label>TARGET DATE (ç‚¹å‡»æ‰“å¼€æ—¥å†)</label> <input type="text" id="dateDisplay" readonly> </div>
            </div>
        </div>
        <div class="info-card">
            <div class="info-item">
                <span class="info-label">æ‰€å±æ—¶åŒº</span>
                <span class="info-value" id="tz-value">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç»åº¦/çº¬åº¦</span>
                <span class="info-value" id="coord-value">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-item">
                <span class="info-label">å›½å®¶åŒºå·</span>
                <span class="info-value" id="country-code-value">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-item">
                <span class="info-label">åœ°åŒºåŒºå·</span>
                <span class="info-value" id="region-code-value">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
    
    <div class="custom-calendar-modal" id="calendarModal">
        <div class="calendar-content" id="calendarContent">
            <div class="close-btn" onclick="closeCalendar()">&times;</div>
            <div class="calendar-header">
                <button class="nav-btn" onclick="navigateMonth(-1)">&#8592;</button>
                <h2 id="currentMonthYear"></h2>
                <button class="nav-btn" onclick="navigateMonth(1)">&#8594;</button>
            </div>
            <div class="calendar-weekdays">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div class="calendar-days-wrapper">
                 <div class="calendar-days" id="calendarDays"></div>
            </div>
            <button class="picker-btn" onclick="closeCalendar()">ç¡®å®š</button>
        </div>
    </div>
    
    <script>
        // --- Canvas Fluid Engine ---
        const canvas = document.getElementById('fluid-canvas'); const ctx = canvas.getContext('2d');
        let width, height, particles = []; let speedMult = 0.02;
        function initCanvas() { width = canvas.width = window.innerWidth / 4; height = canvas.height = window.innerHeight / 4; particles = []; for(let i=0; i<5; i++) { particles.push({ x: Math.random() * width, y: Math.random() * height, vx: (Math.random() - 0.5) * 2, vy: (Math.random() - 0.5) * 2, size: Math.random() * width + width/2, color: [`#ff9a9e`, `#a1c4fd`, `#fbc2eb`, `#d4fc79`, `#fad0c4`][i] }); } }
        function drawFluid() { ctx.clearRect(0, 0, width, height); ctx.globalCompositeOperation = 'screen'; particles.forEach(p => { p.x += p.vx * (speedMult * 50); p.y += p.vy * (speedMult * 50); if(p.x < 0 || p.x > width) p.vx *= -1; if(p.y < 0 || p.y > height) p.vy *= -1; let grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size); grad.addColorStop(0, p.color); grad.addColorStop(1, 'transparent'); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); }); requestAnimationFrame(drawFluid); }

        // --- Clock & Countdown Logic ---
        const timeEl = document.getElementById('time'); const countEl = document.getElementById('countdown');
        const labelEl = document.getElementById('label'); const speedIn = document.getElementById('speed');
        const nameInput = document.getElementById('festName'); const dateDisplayInput = document.getElementById('dateDisplay');
        const calendarModal = document.getElementById('calendarModal'); const calendarContent = document.getElementById('calendarContent');
        const calendarDaysWrapper = document.getElementById('calendarDays');
        speedIn.oninput = (e) => speedMult = parseFloat(e.target.value);
        function update() {
            const now = new Date(); const h = String(now.getHours()).padStart(2, '0'); const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0'); const ms = String(now.getMilliseconds()).padStart(3, '0');
            timeEl.textContent = `${h}:${m}:${s}.${ms}`; const name = nameInput.value; const dateVal = dateDisplayInput.value;
            if (dateVal) { const target = new Date(dateVal + "T00:00:00"); labelEl.textContent = `è·ç¦» ${name}`; const diff = target - now;
                if(diff > 0) { const d = Math.floor(diff / 86400000); const hh = Math.floor((diff/3600000)%24); const mm = Math.floor((diff/60000)%60); const ss = Math.floor((diff/1000)%60); countEl.textContent = `${d}å¤© ${hh}æ—¶ ${mm}åˆ† ${ss}ç§’`; } else { countEl.textContent = "Cheers! ğŸ‡"; }
            } requestAnimationFrame(update);
        }

        // --- Custom Calendar Logic ---
        const allHolidays = {
            "2026-01-01": "å…ƒæ—¦", "2026-02-17": "å†œå†æ–°å¹´ å¤§å¹´åˆä¸€", "2026-04-05": "æ¸…æ˜èŠ‚", "2026-05-01": "åŠ³åŠ¨èŠ‚",
            "2026-06-19": "ç«¯åˆèŠ‚", "2026-09-25": "ä¸­ç§‹èŠ‚", "2026-10-01": "å›½åº†èŠ‚",
            "2027-01-01": "å…ƒæ—¦", "2027-02-06": "å†œå†æ–°å¹´ å¤§å¹´åˆä¸€", "2027-04-05": "æ¸…æ˜èŠ‚", "2027-05-01": "åŠ³åŠ¨èŠ‚",
            "2027-06-15": "ç«¯åˆèŠ‚", "2027-09-15": "ä¸­ç§‹èŠ‚", "2027-10-01": "å›½åº†èŠ‚"
        };
        let currentCalendarDate = new Date(); let selectedDate = new Date(); let isAnimating = false;
        function renderCalendar() {
            if (isAnimating) return; isAnimating = true;
            const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth();
            document.getElementById('currentMonthYear').textContent = `${year}å¹´${month + 1}æœˆ`;
            const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            const newDaysEl = document.createElement('div'); newDaysEl.classList.add('calendar-days', 'days-enter');
            for (let i = 0; i < firstDayOfMonth; i++) { newDaysEl.innerHTML += `<div class="day inactive"></div>`; }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div'); dayDiv.classList.add('day'); dayDiv.textContent = i;
                dayDiv.onclick = () => selectDay(year, month, i);
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) { dayDiv.classList.add('today'); }
                if (year === selectedDate.getFullYear() && month === selectedDate.getMonth() && i === selectedDate.getDate()) { dayDiv.classList.add('selected'); }
                newDaysEl.appendChild(dayDiv);
            }
            if (calendarDaysWrapper.firstChild) { const oldDaysEl = calendarDaysWrapper.firstChild; oldDaysEl.classList.remove('days-enter'); oldDaysEl.classList.add('days-leave'); oldDaysEl.addEventListener('animationend', () => { calendarDaysWrapper.removeChild(oldDaysEl); isAnimating = false; }, { once: true }); } else { isAnimating = false; }
            calendarDaysWrapper.appendChild(newDaysEl);
        }
        function navigateMonth(delta) { if (isAnimating) return; currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta); renderCalendar(); }
        function selectDay(year, month, day) {
            selectedDate = new Date(year, month, day); const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dateDisplayInput.value = dateString;
            if (allHolidays[dateString]) { nameInput.value = allHolidays[dateString]; } else { nameInput.value = `${year}å¹´${month + 1}æœˆ${day}æ—¥`; }
            renderCalendar();
        }
        function openCalendar() { calendarModal.classList.add('is-active'); currentCalendarDate = new Date(dateDisplayInput.value || new Date()); renderCalendar(); }
        function closeCalendar() { calendarModal.classList.remove('is-active'); }
        dateDisplayInput.addEventListener('click', openCalendar);
        calendarContent.addEventListener('wheel', (e) => { e.preventDefault(); if (e.deltaY < 0) { navigateMonth(-1); } else { navigateMonth(1); } });

        // --- åˆå§‹åŒ–èŠ‚æ—¥ ---
        function initializeClock() {
            const today = new Date();
            let nearestHolidayDate = null;
            let minDiff = Infinity;
            for (const dateString in allHolidays) {
                const holidayDate = new Date(dateString + "T00:00:00");
                const diff = holidayDate - today;
                if (diff > 0 && diff < minDiff) { minDiff = diff; nearestHolidayDate = holidayDate; }
            }
            if (nearestHolidayDate) { selectDay(nearestHolidayDate.getFullYear(), nearestHolidayDate.getMonth(), nearestHolidayDate.getDate()); }
            renderCalendar();
        }

        // --- æµè§ˆå™¨åŸç”Ÿ Geolocation + åå‘åœ°ç†ç¼–ç  ---
        async function loadLocationInfo() {
            // å…ˆæ›´æ–°æœ¬åœ°æ—¶åŒºï¼ˆæ— éœ€ä½ç½®æƒé™ï¼‰
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const now = new Date();
            const offsetMinutes = now.getTimezoneOffset();
            const offsetHours = -offsetMinutes / 60;
            const sign = offsetHours >= 0 ? '+' : '';
            const hours = Math.abs(Math.floor(offsetHours));
            const mins = Math.abs(offsetMinutes % 60);
            let offsetDisplay = `${sign}${hours}`;
            if (mins > 0) offsetDisplay += `:${String(mins).padStart(2, '0')}`;
            let tzDesc = `UTC/GMT ${offsetDisplay}å°æ—¶`;
            if (offsetHours === 8 && mins === 0) tzDesc += ' (ä¸œå…«åŒº)';
            tzDesc += ` (${tz})`;
            document.getElementById('tz-value').textContent = tzDesc;

            // å°è¯•è·å–ç²¾ç¡®ä½ç½®ï¼ˆéœ€ç”¨æˆ·å…è®¸æƒé™ï¼Œä¸”é¡µé¢å¿…é¡»åœ¨ secure contextï¼Œå¦‚ localhost æˆ– httpsï¼‰
            if ('geolocation' in navigator) {
                document.getElementById('location-time').textContent = 'è¯·æ±‚ä½ç½®æƒé™...';
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // æ ¼å¼åŒ–ç»çº¬åº¦
                        function toDegMin(coord, isLat) {
                            const abs = Math.abs(coord);
                            const deg = Math.floor(abs);
                            const min = Math.round((abs - deg) * 60);
                            const dir = isLat ? (coord >= 0 ? 'åŒ—çº¬' : 'å—çº¬') : (coord >= 0 ? 'ä¸œç»' : 'è¥¿ç»');
                            const prefix = coord >= 0 ? '+' : '-';
                            return `${dir}${prefix}${deg}Â°${String(min).padStart(2, '0')}`;
                        }
                        document.getElementById('coord-value').textContent = `${toDegMin(lon, false)} / ${toDegMin(lat, true)}`;

                        // åå‘åœ°ç†ç¼–ç ï¼ˆä½¿ç”¨ OpenStreetMap Nominatimï¼Œæ”¯æŒ CORSï¼Œæ— éœ€ API Keyï¼‰
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`, {
                                headers: { 'User-Agent': 'GrokClock/1.0' }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                const address = data.address || {};

                                // åŸå¸‚åç§°ï¼ˆä¼˜å…ˆ city > town > villageï¼‰
                                const city = address.city || address.town || address.village || address.state || 'æœ¬åœ°';
                                document.getElementById('location-time').textContent = `${city.toUpperCase()} TIME`;

                                // å›½å®¶åŠåŒºå·æ˜ å°„ï¼ˆå¸¸è§å›½å®¶ï¼‰
                                const countryCode = address.country_code?.toUpperCase() || '';
                                const countryCallingCodes = {
                                    'CN': '+86(ä¸­å›½)', 'HK': '+852(é¦™æ¸¯)', 'MO': '+853(æ¾³é—¨)', 'TW': '+886(å°æ¹¾)',
                                    'US': '+1(ç¾å›½)', 'GB': '+44(è‹±å›½)', 'JP': '+81(æ—¥æœ¬)', 'KR': '+82(éŸ©å›½)'
                                };
                                const callingCode = countryCallingCodes[countryCode] || `+æœªçŸ¥(${address.country || 'æœªçŸ¥'})`;
                                document.getElementById('country-code-value').textContent = callingCode;

                                // ä¸­å›½å¤§é™†åœ°åŒºåŒºå·ï¼ˆå¸¸è§åŸå¸‚åŒ¹é…ï¼‰
                                let areaCode = 'N/A';
                                if (countryCode === 'CN') {
                                    const cityCodes = {
                                        'Beijing': '10', 'Shanghai': '21', 'Guangzhou': '20', 'Shenzhen': '755',
                                        'Chengdu': '28', 'Chongqing': '23', 'Hangzhou': '571', 'Nanjing': '25',
                                        'Wuhan': '27', "Xi'an": '29', 'Tianjin': '22', 'Suzhou': '512', 'Qingdao': '532'
                                    };
                                    areaCode = cityCodes[city] || cityCodes[address.city] || 'æœªçŸ¥';
                                }
                                document.getElementById('region-code-value').textContent = areaCode;
                            } else {
                                throw new Error('Reverse geocode failed');
                            }
                        } catch (err) {
                            console.error('Reverse geocode error:', err);
                            document.getElementById('location-time').textContent = 'LOCAL TIME';
                            document.getElementById('country-code-value').textContent = 'æ— æ³•è·å–';
                            document.getElementById('region-code-value').textContent = 'N/A';
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        document.getElementById('location-time').textContent = 'LOCAL TIME';
                        document.getElementById('coord-value').textContent = 'æƒé™æ‹’ç»æˆ–ä¸å¯ç”¨';
                        document.getElementById('country-code-value').textContent = 'æ— æ³•è·å–';
                        document.getElementById('region-code-value').textContent = 'N/A';
                    },
                    { timeout: 10000, maximumAge: 600000, enableHighAccuracy: true }
                );
            } else {
                document.getElementById('location-time').textContent = 'LOCAL TIME';
                document.getElementById('coord-value').textContent = 'æµè§ˆå™¨ä¸æ”¯æŒ';
                document.getElementById('country-code-value').textContent = 'æ— æ³•è·å–';
                document.getElementById('region-code-value').textContent = 'N/A';
            }
        }

        // --- åˆå§‹åŒ– ---
        window.onresize = initCanvas;
        initCanvas();
        drawFluid();
        update();
        initializeClock();
        loadLocationInfo();  // è‡ªåŠ¨å°è¯•è·å–ä½ç½®å’Œæ—¶åŒºä¿¡æ¯
    </script>
</body>
</html>
